---
title: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç½²åä»˜ãURLã‚’ä½¿ã£ã¦GCSä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã™ã‚‹"
emoji: "ğŸ—‚"
type: "tech"
topics:
  - "graphql"
  - "react"
  - "gcs"
published: true
published_at: "2022-04-26 00:15"
publication_name: "buyselltech"
---

# ã¯ã˜ã‚ã«

GraphQLã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹é–¢ä¿‚ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã«ã¯

1. ç½²åä»˜ãURLã®ç”Ÿæˆã‚’BEã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
2. å—ã‘å–ã£ãŸç½²åä»˜ãURLã‚’å…ƒã«GCSã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—

ã¨ã„å‡¦ç†ãŒå¿…è¦ã«ãªã‚‹ã®ã§ã™ãŒã€ç½²åä»˜ãURLã‚’ä½¿ç”¨ã—ã¦GCSä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã™ã‚‹ã¾ã§ã«ã„ãã¤ã‹è©°ã¾ã£ãŸã®ã§å‚è€ƒã¾ã§ã«ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã«pushã—ã¦ã‚ã‚Šã¾ã™ã€‚

https://github.com/KazukiHayase/gcs-signed-url-download-sample

# å‰æ

- React 17.0.2 (Next.js 12.0.9)
- ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ã®ç½²åä»˜ãURLã®ç”Ÿæˆæ–¹æ³•ã«ã¤ã„ã¦ã¯è§¦ã‚Œãªã„ã§ã™

# å®Ÿè£…

## ç½²åä»˜ãURLç”ŸæˆAPI

ä»Šå›ã¯å—ã‘å–ã£ãŸç½²åä»˜ãURLã‚’å…ƒã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éƒ¨åˆ†ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã„ã‚‹ã®ã§ã€æ–‡å­—åˆ—ã‚’è¿”ã™ã ã‘ã®ç°¡å˜ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚

```tsx
import { NextApiRequest, NextApiResponse } from "next";

const handler = (_req: NextApiRequest, res: NextApiResponse) => {
  const signedDownloadUrl = ""; // gsutilã§ç”Ÿæˆã—ãŸç½²åä»˜ãURLã‚’ä»£å…¥
  res.status(200).json({ signedDownloadUrl });
};

export default handler;
```

gsutilã‚³ãƒãƒ³ãƒ‰ãªã©ã§ç”Ÿæˆã—ãŸURLã‚’ä¸Šè¨˜ã«ä»£å…¥ã™ã‚‹ã“ã¨ã§ã€ç½²åä»˜ãURLã‚’ç”Ÿæˆã™ã‚‹APIã®ä»£ã‚ã‚Šã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
gsutil signurl -m GET -d 12h -c text/csv -u gs://sample-bucket/sample.csv
```

[V4 signing process with Cloud Storage tools | Google Cloud](https://cloud.google.com/storage/docs/access-control/signing-urls-with-helpers)

## ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°

æ¬¡ã«ç½²åä»˜ãURLã‚’å…ƒã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã™ã‚‹é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```tsx
import saveAs from "file-saver";

export const downloadFile = async (
  signedDownloadUrl: string,
  contentType: string,
  fileName: string
): Promise<void> => {
  const res = await fetch(signedDownloadUrl, {
    method: "GET",
    headers: { "Content-Type": contentType },
  });
  if (!res.ok) {
    return Promise.reject(new Error("Fail to download file from GCS"));
  }
  const blob = await res.blob();

  saveAs(blob, fileName);
};
```

å—ã‘å–ã£ãŸç½²åä»˜ãURLã«å¯¾ã—ã¦GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€ãã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’blobã«å¤‰æ›å¾Œã€`file-saver`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®`saveAs`ã¨ã„ã†é–¢æ•°ã§ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚

æœ€åˆã¯URLã«å¯¾ã—ã¦GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ãŸã‚‰è‡ªå‹•çš„ã«ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚ŒãŸã‚Šã™ã‚‹ã®ã‹ãªã¨æ€ã£ã¦ã„ãŸã®ã§ã™ãŒã€ãã†ã§ã¯ãªãã‚ãã¾ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å—ã‘å–ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã™ã‚‹ãŸã‚ã®å‡¦ç†ã¯åˆ¥ã§å¿…è¦ã§ã—ãŸã€‚

ãã‚ŒãŒä¸Šè¨˜ã®`saveAs`ã®éƒ¨åˆ†ã«å½“ãŸã‚‹ã®ã§ã™ãŒã€ã“ã®é–¢æ•°ã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«jsã§aã‚¿ã‚°ã®ç”Ÿæˆã€ã‚¯ãƒªãƒƒã‚¯ã‚’è¡Œã†ã“ã¨ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã¸ã®ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```tsx
var a = document.createElement('a')
a.href = blob
a.target = '_blank'
setTimeout(function () { click(a) })
```

https://github.com/eligrey/FileSaver.js

## ãƒšãƒ¼ã‚¸å®Ÿè£…

æœ€å¾Œã«APIãƒªã‚¯ã‚¨ã‚¹ãƒˆéƒ¨åˆ†ã¨ä¸Šè¨˜ã®å®Ÿè£…ã—ãŸé–¢æ•°ã®ã¤ãªãã“ã¿ã‚’è¡Œã†ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã™ã‚Œã°å®Œæˆã§ã™ï¼

```tsx
const IndexPage = () => {
  const handleClick: MouseEventHandler<HTMLButtonElement> = async () => {
    try {
      const res = await fetch("api/signedUrl", { method: "GET" });
      const data = await res.json();
      const signedDownloadUrl = data.signedDownloadUrl;
      await downloadFile(signedDownloadUrl, "text/csv", "sample.csv");
    } catch (e) {
      console.log(e);
    }
  };

  return (
    <div>
      <h1>GCS signed download url sample</h1>
      <button onClick={handleClick}>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>
  );
};
```

# è©°ã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆ

ä¸Šè¨˜ã®å®Ÿè£…å†…å®¹ä»¥å¤–ã«ã‚‚ã„ãã¤ã‹è©°ã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆãŒã‚ã£ãŸã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚

## ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã§Content-Typeã‚’æŒ‡å®šã™ã‚‹

ç½²åä»˜ãURLã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹éš›ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã€**URLç”Ÿæˆæ™‚ã«æŒ‡å®šã—ãŸ**Content-Typeã‚’å«ã‚ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ï¼ˆURLç”Ÿæˆæ™‚ã«æŒ‡å®šã—ã¦ã„ãªã„å ´åˆã¯ä¸è¦ï¼‰

ä¸Šè¨˜ã®ä¾‹ã ã¨

```tsx
gsutil signurl -m GET -d 12h -c text/csv -u gs://sample-bucket/sample.csv
```

ã¨`-c`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§Content-Typeã«`text/csv`ã¨æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ã€ç½²åä»˜ãURLã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹éš›ã®Content-Typeãƒ˜ãƒƒãƒ€ãƒ¼ã«ã¯`text/csv`ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## CORSè¨­å®š

ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã¯ãƒã‚±ãƒƒãƒˆå´ã«CORSã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

å‚è€ƒã¾ã§ã«ä¸Šè¨˜ã®å®Ÿè£…ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã™ãŸã‚ã®CORSè¨­å®šã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```tsx
[
    {
      "origin": ["http://localhost:3000"],
      "method": ["GET"],
      "responseHeader": ["Content-Type"],
      "maxAgeSeconds": 3600
    }
]
```

https://cloud.google.com/storage/docs/configuring-cors

# ã¾ã¨ã‚

GaphQLã‚’æ¡ç”¨ã—ãŸéš›ã«ã¯RESTã¨ã¯ç•°ãªã‚‹æ–¹æ³•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰±ã†å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ãã®æ–¹æ³•ã®ä¸€ã¤ã¨ã—ã¦å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ï¼
