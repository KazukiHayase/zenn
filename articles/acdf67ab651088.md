---
title: "ç›®ç‰æ©Ÿèƒ½æº€è¼‰ã® Apollo Client 3.8 ã®ãƒªãƒªãƒ¼ã‚¹ç´¹ä»‹"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react", "graphql", "apollo", "apolloclient", "frontend"]
published: true
publication_name: "buyselltech"
---

å…ˆæ—¥ Apollo Client 3.8 ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ Apollo Client å²ä¸Šæœ€å¤§ã®ãƒã‚¤ãƒŠãƒ¼ãƒªãƒªãƒ¼ã‚¹ã§ã€å¾…æœ›ã® Suspense å¯¾å¿œã‚„ã€ä»–ã«ã‚‚æ§˜ã€…ãªæ©Ÿèƒ½ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ã€ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸæ©Ÿèƒ½ã¨ã€ãã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

# Suspense å¯¾å¿œ

ã¾ãšã¯ä¸€ç•ªã®ç›®ç‰ã§ã‚ã‚‹ [Suspense](https://react.dev/reference/react/Suspense) å¯¾å¿œã§ã™ã€‚Relay ã‚„ urql ãŒ Suspense ã«å¯¾å¿œã—ã¦ã„ã‚‹ä¸­ã€ã¤ã„ã« Apollo Client ã‚‚ Suspense ã«å¯¾å¿œã—ã¾ã—ãŸï¼
ä»Šå›ã®ãƒªãƒªãƒ¼ã‚¹ã§ã¯ Suspense ã«å¯¾å¿œã—ãŸ 3 ã¤ hooks ãŒè¿½åŠ ã•ã‚ŒãŸã®ã§é †ç•ªã«ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚

## `useSuspenseQuery`

`useSuspenseQuery`ã¯`useQuery`ã® Suspense å¯¾å¿œç‰ˆã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¡Œã‚ã‚Œã¦ã„ã‚‹æœ€ä¸­ã¯å‘¼ã³å‡ºã—å…ƒã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã‚µã‚¹ãƒšãƒ³ãƒ‰ã•ã›ã¾ã™ã€‚
Apollo Client ã‚’ä½¿ã£ãŸã“ã¨ã‚ã‚‹æ–¹ã§ã‚ã‚Œã°ã€ä¸€åº¦ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªå‡¦ç†ã‚’æ›¸ã„ãŸã“ã¨ãŒã‚ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
`loading`ã«ã‚ˆã£ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®è¡¨ç¤ºã‚’åˆ¶å¾¡ã—ã€`data`ã¯`undefined`ã®å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€å€¤ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã‚’ã—ã¦ã‹ã‚‰ä½¿ç”¨ã—ã¾ã™ã€‚

```tsx
export const SomeComponent: React.FC = () => {
  const { data, loading } = useQuery(SomeQuery);

  if (loading) return <>Loading...</>;
  return <>{data && <>{/* dataã‚’ä½¿ã£ãŸè¡¨ç¤º */}</>}</>;
};
```

ã“ã‚ŒãŒ`useSuspenseQuery`ã§ã¯ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯ã‚µã‚¹ãƒšãƒ³ãƒ‰ã—ã¦ãã‚Œã‚‹ã®ã§ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®è¡¨ç¤ºã¯è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æŒ‡å®šã—ã¾ã™ã€‚ã¾ãŸã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Œäº†ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ãªã‚‹ã®ã§ã€`data`ãŒ`undefined`ã®å¯èƒ½æ€§ãŒãªã‚Šããªã‚Šã€å­˜åœ¨ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†å¿…è¦ãŒãªããªã‚Šã¾ã™ï¼

```tsx
export const UserWithUseSuspenseQuery: React.FC = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <User />
    </Suspense>
  );
};

const User: React.FC = () => {
  const { data } = useSuspenseQuery(FetchUserQueryForSuspense);

  return (
    <div>
      <h1>User</h1>
      {/* dataã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’ã—ãªãã¦ã‚‚ã„ã„ï¼ */}
      <h2>name: {data.user.name}</h2>
    </div>
  );
};
```

ã¾ãŸã€[Transitions](https://react.dev/blog/2022/03/29/react-v18#new-feature-transitions)ã‚‚åˆ©ç”¨å¯èƒ½ã§ã€refetch ã®éš›ã« fallback ã«æŒ‡å®šã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ãªãã€ç›´å‰ã®ãƒ‡ãƒ¼ã‚¿ã§ã®è¡¨ç¤ºã‚’ç¶­æŒã—ã¦ UX ã®å‘ä¸Šã‚’å›³ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```tsx
import { startTransition } from "react";

const User: React.FC = () => {
  const { data, refetch } = useSuspenseQuery(FetchUserQueryForSuspense);

  const handleRefetch = () => {
    startTransition(() => {
      refetch();
    });
  };

  // ...
};
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«é–¢ã—ã¦ã‚‚å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ä»Šã¾ã§ã¯`useQuery`ã®è¿”ã‚Šå€¤ã®`error`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã—ãŸã€‚ãã‚ŒãŒ`useSuspenseQuery`ã§ã¯[React Error Boundaries](https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary)ã‚’æœ€å¤§é™æ´»ç”¨ã™ã‚‹æ–¹é‡ã«ãªã‚Šã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ throw ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨åŒã˜ã‚ˆã†ã«ã€è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã§`ErrorBoundary`ã§ãƒ©ãƒƒãƒ—ã—ã¦åˆ¶å¾¡ã™ã‚‹å½¢ã«ãªã‚Šã¾ã™ã€‚

```tsx
<ErrorBoundary fallback={<p>Something went wrong</p>}>
  <User />
</ErrorBoundary>
```

`errorPolicy`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ä»Šã¾ã§é€šã‚Š`error`ã‚’ä½¿ã£ãŸå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```tsx
const { data, error } = useSuspenseQuery(SomeQuery, {
  errorPolicy: "all",
});
```

## `useBackgroundQuery`, `useReadQuery`

### ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«å•é¡Œ

`useSuspenseQuery`ã«ã‚ˆã£ã¦ã‚µã‚¹ãƒšãƒ³ã‚¹ã«å¯¾å¿œã•ã›ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ãŸã ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®éšå±¤ãŒæ·±ããªã‚Šã€ãã‚Œãã‚Œã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§`useSuspenseQuery`ã‚’å‘¼ã³å‡ºã—ã¦ã—ã¾ã†ã¨ã€ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã™ã€‚
ä¸‹è¨˜ã¯ãƒã‚¹ãƒˆã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ãã‚Œãã‚Œ`useSuspenseQuery`ã‚’å‘¼ã³å‡ºã—ã€ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ä¾‹ã§ã™ã€‚
User ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒå®Œäº†ã—ãŸå¾Œã«ã€Todos ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

```tsx
export const UserWithUseSuspenseQuery: React.FC = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <User />
    </Suspense>
  );
};

const User: React.FC = () => {
  const { data } = useSuspenseQuery(FetchUserQueryForSuspense, {
    variables: { id: "1" },
  });
  const user = data.user;

  if (!user) return <>Not found</>;
  return (
    <div>
      <h1>User</h1>
      <h2>name: {user.name}</h2>
      <Suspense fallback={<div>Loading...</div>}>
        <Todos />
      </Suspense>
    </div>
  );
};

const Todos: React.FC = () => {
  const { data } = useSuspenseQuery(FetchTodosQueryForSuspense);
  const todos = data.todos;

  return (
    <div>
      <h1>Todos</h1>
      <ul>
        {todos.map((todo: any) => (
          <li key={todo.id}>
            {todo.text} {todo.done ? "âœ…" : "âŒ"}
          </li>
        ))}
      </ul>
    </div>
  );
};
```

![](/images/acdf67ab651088/demo1.gif)

### `useBackgroundQuery`ã¨`useReadQuery`ã«ã‚ˆã‚‹ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«å•é¡Œã®è§£æ±º

ã“ã®ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«å•é¡Œã‚’`useBackgroundQuery`ã¨`useReadQuery`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã¾ã™ï¼
`useBackgroundQuery`ã¯å‘¼ã³å‡ºã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’é–‹å§‹ã—ã¾ã™ã€‚`useBackgroundQuery`ã‹ã‚‰å—ã‘å–ã£ãŸ`queryRef`ã‚’æ¸¡ã—ã¦`useReadQuery`ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãŒå®Œäº†ã™ã‚‹å‰ã«`useReadQuery`ãŒå‘¼ã³å‡ºã•ã‚ŒãŸå ´åˆã¯ã€å‘¼ã³å‡ºã—å…ƒã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚µã‚¹ãƒšãƒ³ãƒ‰ã•ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚ã‚‰ã‹ã˜ã‚`useBackgroundQuery`ã‚’å‘¼ã³å‡ºã—ã¦ãŠãã“ã¨ã§ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’èµ°ã‚‰ã›ã¦ãŠã‘ã‚‹ã®ã§ã€ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«å•é¡Œã‚’è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

```tsx
export const UserWithUseBackgroundQuery: React.FC = () => {
  // ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒé–‹å§‹ã™ã‚‹ã®ã§ã€UserãŒã‚µã‚¹ãƒšãƒ³ãƒ‰ã•ã‚Œã¦ã‚‚ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«å•é¡Œã¯ç™ºç”Ÿã—ãªã„
  const [queryRef] = useBackgroundQuery(FetchTodosQueryForBackground);

  return (
    <Suspense fallback={<div>Loading...</div>}>
      <User queryRef={queryRef} />
    </Suspense>
  );
};

const User: React.FC<{
  queryRef: QueryReference<FetchTodosQueryForBackgroundQuery>;
}> = ({ queryRef }) => {
  const { data } = useSuspenseQuery(FetchUserQueryForBackground, {
    variables: { id: "1" },
  });
  const user = data.user;

  if (!user) return <>Not found</>;
  return (
    <div>
      <h1>User</h1>
      <h2>name: {user.name}</h2>
      <Suspense fallback={<div>Loading...</div>}>
        <Todos queryRef={queryRef} />
      </Suspense>
    </div>
  );
};

const Todos: React.FC<{
  queryRef: QueryReference<FetchTodosQueryForBackgroundQuery>;
}> = ({ queryRef }) => {
  const { data } = useReadQuery(queryRef);
  const todos = data.todos;

  return (
    <div>
      <h1>Todos</h1>
      <ul>
        {todos.map((todo: any) => (
          <li key={todo.id}>
            {todo.text} {todo.done ? "âœ…" : "âŒ"}
          </li>
        ))}
      </ul>
    </div>
  );
};
```

![](/images/acdf67ab651088/demo2.gif)

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦³ç‚¹

`useBackgroundQuery`ã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã®é–‹å§‹ã®ã¿ã‚’è¡Œã„ã€ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯æ‹…å½“ã›ãšã€ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯`useReadQuery`ãŒæ‹…å½“ã—ã¾ã™ã€‚ãã®ãŸã‚ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã€å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã¯`useReadQuery`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿ã§ã€`useBackgroundQuery`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ä¸‹å±¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿ã«ãªã‚‹ã®ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå‘ä¸Šã—ã¾ã™ã€‚

# `useFragment`ã¨`@nonreactive`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–

:::message
`useFragment`é–¢é€£ã®èª¬æ˜ã‚’ã™ã‚‹ã«å½“ãŸã£ã¦ã€Fragment Colocation ã®å°å…¥ãŒå‰æã«ãªã£ã¦ã„ã‚‹ç®‡æ‰€ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚
Fragment Colocation ã‚’ã”å­˜çŸ¥ãªã„æ–¹ã¯ä¸‹è¨˜ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
:::

https://speakerdeck.com/kazukihayase/reacttographqlteshi-xian-suruxuan-yan-de-tetahuetuti?slide=14

ä»¥å‰ã‹ã‚‰ experimental ã§å…¬é–‹ã•ã‚Œã¦ã„ãŸ`useFragment`ãŒã€ä»Šå›ã®ãƒªãƒªãƒ¼ã‚¹ã§ Stable ã«ãªã‚Šã¾ã—ãŸï¼
`useFragment`ã¯å®šç¾©ã—ãŸ Fragment ã§å®šç¾©ã—ãŸãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã® hooks ã§ã™ã€‚`useQuery`ãªã©ã¨åŒã˜ã‚ˆã†ã«ã€ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‹ Fragment ã®ãƒ‡ãƒ¼ã‚¿ã«æ›´æ–°ãŒã‚ã£ãŸå ´åˆã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒèµ°ã‚Šã€å¸¸ã«æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»Šã¾ã§ã¯ Apollo Client å˜ä½“ã§ã¯ Fragment Colocation ã‚’è¡Œã†ã®ãŒé›£ã—ã‹ã£ãŸã®ã§ã™ãŒã€`useFragment`ã«ã‚ˆã£ã¦ãã‚ŒãŒæ”¹å–„ã•ã‚Œã¾ã™ã€‚
ã¾ãŸã€å¾Œè¿°ã—ã¾ã™ãŒã€GraphQL Code Generator ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»é–‹ç™ºè€…ä½“é¨“ã®ã©ã¡ã‚‰ã‚‚é«˜ã‚ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

```tsx
const Todo: React.FC<{ id: string }> = ({ id }) => {
  const { complete, data: todo } = useFragment({
    fragment: TodoFragmentForUseFragment,
    fragmentName: "TodoFragmentForUseFragment",
    from: {
      __typename: "Todo",
      id,
    },
  });

  if (!complete) return null;
  return (
    <li>
      {todo.text} {todo.done ? "âœ…" : "âŒ"}
    </li>
  );
};
```

## `@nonreactive`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–

`@nonreactive`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯ Query ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚„ã€Fragment ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ã«å¯¾ã—ã¦ä½¿ç”¨ã§ãã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§ã™ã€‚`@nonreactive`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚„ Fragment ã®ã‚µãƒ–ãƒ„ãƒªãƒ¼ã«å«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ãŒã‚ã£ãŸã¨ã—ã¦ã‚‚ã€å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã—ãªããªã‚Šã¾ã™ã€‚

ä¸‹è¨˜ã¯ Todo ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã€ãã®å†…ã®ä¸€ã¤ã® Todo ã‚’æ›´æ–°ã™ã‚‹ä¾‹ã§ã™ã€‚
`@nonreactive`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ç”¨ã—ã¦ãªã„å ´åˆã¯ã€æ›´æ–°å¾Œã«ãƒšãƒ¼ã‚¸å…¨ä½“ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã®ã«å¯¾ã—ã€`@nonreactive`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ç”¨ã—ãŸå ´åˆã¯ãƒªã‚¹ãƒˆå†…ã®è©²å½“ã® Todo éƒ¨åˆ†ã®ã¿ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚

### `@nonreactive`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ç”¨ã—ãªã„å ´åˆ

```graphql
query FetchUserQueryForUseFragment($id: ID!) {
  user(id: $id) {
    id
    name
    todos {
      id
      ...TodoFragmentForUseFragment
    }
  }
}

fragment TodoFragmentForUseFragment on Todo {
  id
  text
  done
}
```

:::details å®Ÿè£…

```tsx
import { Suspense } from "react";
import { graphql } from "../gql/gql";
import { useFragment, useMutation, useSuspenseQuery } from "@apollo/client";

const FetchUserQueryForUseFragment = graphql(/* GraphQL */ `
  query FetchUserQueryForUseFragment($id: ID!) {
    user(id: $id) {
      id
      name
      todos {
        id
        ...TodoFragmentForUseFragment
      }
    }
  }
`);

export const UserWithUseFragment: React.FC = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <User />
    </Suspense>
  );
};

const User: React.FC = () => {
  const userId = "1";
  const { data } = useSuspenseQuery(FetchUserQueryForUseFragment, {
    variables: { id: userId },
  });
  const user = data.user;

  if (!user) return <>Not found</>;
  return (
    <div>
      <h1>User</h1>
      <h2>name: {user.name}</h2>
      <h1>Todos</h1>
      <ul>
        {user.todos.map(({ id }) => (
          <Todo key={id} id={id} />
        ))}
      </ul>
    </div>
  );
};

const ToggleDoneMutation = graphql(/* GraphQL */ `
  mutation ToggleDoneMutation($id: ID!, $done: Boolean!) {
    updateTodo(input: { id: $id, done: $done }) {
      id
      done
    }
  }
`);

const TodoFragmentForUseFragment = graphql(/* GraphQL */ `
  fragment TodoFragmentForUseFragment on Todo {
    id
    text
    done
  }
`);

const Todo: React.FC<{ id: string }> = ({ id }) => {
  const [toggleDone] = useMutation(ToggleDoneMutation);

  const { complete, data: todo } = useFragment({
    fragment: TodoFragmentForUseFragment,
    fragmentName: "TodoFragmentForUseFragment",
    from: {
      __typename: "Todo",
      id,
    },
  });

  if (!complete) return null;
  return (
    <li key={todo.id}>
      {`${todo.text} `}
      <span
        onClick={() =>
          toggleDone({ variables: { id: todo.id, done: !todo.done } })
        }
        style={{ cursor: "pointer" }}
      >
        {todo.done ? "âœ…" : "âŒ"}
      </span>
    </li>
  );
};
```

:::

![](/images/acdf67ab651088/demo3.gif)

### `@nonreactive`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ç”¨ã—ãŸå ´åˆ

```graphql
query FetchUserQueryForUseFragmentNonreactive($id: ID!) {
  user(id: $id) {
    id
    name
    todos {
      id
      # ä¸‹è¨˜ã§@nonreactiveã‚’æŒ‡å®š
      ...TodoFragmentForUseFragmentNonreactive @nonreactive
    }
  }
}

fragment TodoFragmentForUseFragmentNonreactive on Todo {
  id
  text
  done
}
```

:::details å®Ÿè£…ï¼ˆå…¨ä½“ï¼‰

```tsx
import { Suspense } from "react";
import { graphql } from "../gql/gql";
import { useFragment, useMutation, useSuspenseQuery } from "@apollo/client";

const FetchUserQueryForUseFragmentNonreactive = graphql(/* GraphQL */ `
  query FetchUserQueryForUseFragmentNonreactive($id: ID!) {
    user(id: $id) {
      id
      name
      todos {
        id
        ...TodoFragmentForUseFragmentNonreactive @nonreactive
      }
    }
  }
`);

export const UserWithUseFragmentNonreactive: React.FC = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <User />
    </Suspense>
  );
};

const User: React.FC = () => {
  const userId = "1";
  const { data } = useSuspenseQuery(FetchUserQueryForUseFragmentNonreactive, {
    variables: { id: userId },
  });
  const user = data.user;

  if (!user) return <>Not found</>;
  return (
    <div>
      <h1>User</h1>
      <h2>name: {user.name}</h2>
      <h1>Todos</h1>
      <ul>
        {user.todos.map(({ id }) => (
          <Todo key={id} id={id} />
        ))}
      </ul>
    </div>
  );
};

const ToggleDoneMutation = graphql(/* GraphQL */ `
  mutation ToggleDoneMutation($id: ID!, $done: Boolean!) {
    updateTodo(input: { id: $id, done: $done }) {
      id
      done
    }
  }
`);

const TodoFragmentForUseFragmentNonreactive = graphql(/* GraphQL */ `
  fragment TodoFragmentForUseFragmentNonreactive on Todo {
    id
    text
    done
  }
`);

const Todo: React.FC<{ id: string }> = ({ id }) => {
  const [toggleDone] = useMutation(ToggleDoneMutation);

  const { complete, data: todo } = useFragment({
    fragment: TodoFragmentForUseFragmentNonreactive,
    fragmentName: "TodoFragmentForUseFragmentNonreactive",
    from: {
      __typename: "Todo",
      id,
    },
  });

  if (!complete) return null;
  return (
    <li key={todo.id}>
      {`${todo.text} `}
      <span
        onClick={() =>
          toggleDone({ variables: { id: todo.id, done: !todo.done } })
        }
        style={{ cursor: "pointer" }}
      >
        {todo.done ? "âœ…" : "âŒ"}
      </span>
    </li>
  );
};
```

:::

![](/images/acdf67ab651088/demo4.gif)

## GraphQL Code Generator ã® Fragment Masking ã¨ã®æ£²ã¿åˆ†ã‘

GraphQL Code Generator ã®`client-preset`ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ Fragment Masking ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã‚‚ã€Fragment Colocation ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

ãã¡ã‚‰ã¨ã®æ£²ã¿åˆ†ã‘ã§ã™ãŒ

- Query ã®å®šç¾©ã¯ GraphQL Code Generator ã§ç”Ÿæˆã•ã‚Œã‚‹[graphql é–¢æ•°](https://the-guild.dev/graphql/codegen/docs/guides/react-vue#writing-graphql-queries)ã‚’ä½¿ç”¨
- ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¯ Apollo Client ã®`useFragment`ã‚’ä½¿ç”¨

ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚

ç†ç”±ã¯ Fragment Colocation ã®å¼·åˆ¶ã‚’ã—ã¤ã¤ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‰ã§ã™ã€‚

### GraphQL Code Generator ã® graphql é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã¨è‰¯ã„ç†ç”±

ä¸‹è¨˜ã¯ GraphQL Code Generator ã® graphql é–¢æ•°ã‚’ä½¿ã£ã¦ Query ã‚’å®šç¾©ã—ãŸä¾‹ãªã®ã§ã™ãŒã€ç”Ÿæˆã•ã‚Œã‚‹å‹æƒ…å ±ã« Fragment ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æƒ…å ±ã¯å«ã¾ã‚Œãªã„ã®ã§ã€Fragment ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯`data`ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€Fragment ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã¯ã€GraphQL Code Generator ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®`useFragment`ã‹ã€Apollo Client ã®`useFragment`ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€Fragment Colocation ã‚’å¼·åˆ¶ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãã®ãŸã‚ã€Query ã®å®šç¾©ã«ã¯ GraphQL Code Generator ã® graphql é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹æ–¹ãŒè‰¯ã„ã§ã™ã€‚

```tsx
const FetchUserQueryForUseFragment = graphql(/* GraphQL */ `
  query FetchUserQueryForUseFragment($id: ID!) {
    user(id: $id) {
      id
      name
      todos {
        id
        ...TodoFragmentForUseFragment
      }
    }
  }
`);

const TodoFragmentForUseFragment = graphql(/* GraphQL */ `
  fragment TodoFragmentForUseFragment on Todo {
    id
    text
    done
  }
`);

const User: React.FC = () => {
  const userId = "1";
  const { data } = useSuspenseQuery(FetchUserQueryForUseFragment, {
    variables: { id: userId },
  });

  console.log(data.text);
  // ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã€Queryã®dataã‹ã‚‰ã¯Fragmentå†…éƒ¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
  // typescript: Property 'text' does not exist on type 'FetchUserQueryForUseFragmentQuery'. [2339]

  // ...
};
```

### Apollo Client ã®`useFragment`ã‚’ä½¿ç”¨ã™ã‚‹ã¨è‰¯ã„ç†ç”±

GraphQL Code Generator ã§ã¯ graphql é–¢æ•°ã¨ä¸€ç·’ã«ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ã‚ã‚‹[useFragment](https://the-guild.dev/graphql/codegen/plugins/presets/preset-client#the-usefragment-helper)ã‚‚ç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Fragment ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã€ã“ã®`useFragment`ã¯å†…éƒ¨çš„ã«ã¯å‹å¤‰æ›ã‚’è¡Œã£ã¦ã„ã‚‹ã ã‘ã§ã€å®Ÿéš›ã¯ hooks ã§ã¯ãªããŸã ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ã™ã€‚ãã®ãŸã‚ã€Fragment ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã‚‚ã€Query ã®å‘¼ã³å‡ºã—ã‚’è¡Œã£ã¦ã„ã‚‹è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé…ä¸‹å…¨ã¦ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ãã“ã§ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«ã¯`@nonreactive`ã¨ Apollo Client ã®`useFragment`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Fragment ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã«å¤‰æ›´ãŒå ´åˆã¯ã€ãã® Fragment ã«å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Šã‚’å›³ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

# `removeTypenameFromVariables` Link

`removeTypenameFromVariables`ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® variables ã‹ã‚‰`__typename`ã‚’è‡ªå‹•çš„ã«å–ã‚Šé™¤ã„ã¦ãã‚Œã‚‹ Apollo Link ã§ã™ã€‚

Apollo Client ã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®éƒ½åˆã§è‡ªå‹•çš„ã« Query ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«`__typename`ãŒè¿½åŠ ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€Query ã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ Mutation ã® variables ã§ä½¿ç”¨ã—ã¦ã—ã¾ã†ã¨ã€variables ã«`__typename`ãŒå«ã¾ã‚Œã¦ã—ã¾ã„ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã“ã¨ãŒå¤šã€…ã‚ã‚Šã¾ã—ãŸã€‚
ã“ã‚Œã¯å€‹äººçš„ã«ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°å‡¦ç†ãªã©ã§ã‚ˆãç™ºç”Ÿã—ãŸå•é¡Œã§ã€ãã®éš›ã¯ä¸‹è¨˜ã®ã‚ˆã†ã« Mutation ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«æ˜ç¤ºçš„ã«`__typename`ã‚’å–ã‚Šé™¤ã„ã¦ã„ãŸã®ã§ã™ãŒã€éå¸¸ã«ã‚ã‚“ã©ãã•ã‹ã£ãŸã§ã™ã€‚

```typescript
const { __typename: _, ...rest } = someData;
```

ãã“ã§`removeTypenameFromVariables`ã‚’ä½¿ã†ã“ã¨ã§ã€ä¸Šè¨˜ã®ã‚ˆã†ãªå®Ÿè£…ã‚’ã™ã‚‹ã“ã¨ãªãã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® variables ã‹ã‚‰`__typename`ã‚’å–ã‚Šé™¤ãã“ã¨ãŒã§ãã¾ã™ï¼

# `skipToken`

hooks ã¯æ¡ä»¶ä»˜ãã§å‘¼ã³å‡ºã™ã“ã¨ã¯ã§ããªã„ã®ã§ã€skip ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€å‹è§£æ±ºãŒã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã—ãŸã€‚

```tsx
const { data } = useQuery(SomeQuery, {
  variables: { id },
  skip: !id,
});

// => Type 'number | undefined' is not assignable to type 'number'.
//      Type 'undefined' is not assignable to type 'number'.ts(2769)
```

ä¸Šè¨˜ã®ä¾‹ã§ã¯ id ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ Query ã‚’å®Ÿè¡Œã™ã‚‹ã®ã§ã€variables ã«æ¸¡ã—ã¦ã‚‹å®Ÿãƒ‡ãƒ¼ã‚¿ã® id ãŒ`undefined`ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚Šå¾—ãªã„ã®ã§ã™ãŒã€å‹è§£æ±ºãŒã§ããšã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ç„¡ç†ã‚„ã‚Šè§£æ±ºã—ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚

```tsx
const { data } = useSuspenseQuery(SomeQuery, {
  variables: { id: id! },
  skip: !id,
});

// or

const { data } = useSuspenseQuery(query, {
  variables: { id: id ?? 0 },
  skip: !id,
});
```

ãã“ã§ã€ä»Šå›ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ`skipToken`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å‹å®‰å…¨ã« Query ã‚’ã‚¹ã‚­ãƒƒãƒ—ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼

```tsx
import { skipToken } from "@apollo/client";

const { data } = useSuspenseQuery(
  query,
  id ? { variables: { id } } : skipToken
);
```

# Document transforms

Apollo Client ã§ã¯ Qeury ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«è‡ªå‹•çš„ã«`__typename`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ GrahQL ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å¤‰æ›ã™ã‚‹ document transforms ã¨ã„ã†å†…éƒ¨çš„ãªæ©Ÿèƒ½ã«ã‚ˆã‚‹ã‚‚ã®ãªã®ã§ã™ãŒã€ã“ã®æ©Ÿèƒ½ãŒä»Šå›ã®ãƒªãƒªãƒ¼ã‚¹ã§å…¬é–‹ã•ã‚Œã€è‡ªç”±ã«åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼
ã“ã‚Œã«ã‚ˆã‚Šã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰ã«è‡ªç”±ã« GraphQL ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ä»¥å‰ã‚‚ Apollo Link ã«ã‚ˆã£ã¦å®Ÿç¾ã¯ã§ããŸã®ã§ã™ãŒã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒ GraphQL ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¤‰æ›´ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãã‚Œã«ã‚ˆã‚Š Link å†…ã§å®‰å…¨ã«å®Ÿè¡Œã§ãã‚‹å¤‰æ›ã®ç¨®é¡ãŒåˆ¶é™ã•ã‚Œã¦ã¾ã—ãŸãŒã€ä»Šå›ã®æ©Ÿèƒ½ãŒå…¬é–‹ã•ã‚ŒãŸã“ã¨ã§ã€ã‚ˆã‚Šè‡ªç”±ã« GraphQL ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¤‰æ›ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

`__typename`ã¨`id`ãªã©ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ­£è¦åŒ–ã«å¿…ãšå¿…è¦ãªã®ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§æ¼ã‚Œãªãå–å¾—ã•ã›ãŸã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆã‚„ã€é€†ã«æ¨©é™ãªã©ã®æ¡ä»¶ã«ã‚ˆã£ã¦ã¯å«ã‚ãŸããªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ãªã©ã®ä½¿ã„æ–¹ãŒã§ããã†ã§ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã« id ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…ãšå«ã‚ã‚‹ã¨ã„ã†å®Ÿè£…ã®ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã‚‹ã®ã§ã€èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯ã”è¦§ãã ã•ã„ã€‚

https://www.apollographql.com/docs/react/data/document-transforms/#write-your-own-document-transform

# æ–°ã—ã„ã‚¨ãƒ©ãƒ¼æŠ½å‡ºãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

ã‚¨ãƒ©ãƒ¼ã®æŠ½å‡ºã«ã¯å‡¦ç†ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚Šã€ãã®çµæœãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒå¢—ãˆã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã«å¯¾å¿œã™ã‚‹ãŸã‚ã«ã€ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¸›ã‚‰ã™ã“ã¨ã§ã€ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®ç¯€ç´„ã‚’è¡Œã£ã¦ã¾ã—ãŸã€‚ãŸã ãã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ©ãƒ¼ã®åŸå› ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ç‰¹å®šã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã‚Šã€ã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹å‹•çš„ãªæƒ…å ±ãŒå¤±ã‚ã‚Œã¦ã„ãŸã‚Šã—ã¾ã—ãŸã€‚

ä¸Šè¨˜ã®èª²é¡Œã«å¯¾ã—ã¦ä»Šå›ã®ãƒªãƒªãƒ¼ã‚¹ã§ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è‡ªä½“ã¯ã‚³ã‚¢ãƒãƒ³ãƒ‰ãƒ«ã‹ã‚‰çœç•¥ã™ã‚‹ã“ã¨ã§ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’æ¸›ã‚‰ã—ã€ä»£ã‚ã‚Šã«ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’æ¸›ã‚‰ã—ã¤ã¤ã€ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’æä¾›ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼

ä¸‹è¨˜ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã®ä¾‹ã§ã™ã€‚

```
An error occured! For more details, see the full error text at https://go.apollo.dev/c/err#%7B%22version%22%3A%223.8.1%22%2C%22message%22%3A69%2C%22args%22%3A%5B%222%22%5D%7D
```

https://go.apollo.dev/c/err#%7B%22version%22%3A%223.8.1%22%2C%22message%22%3A69%2C%22args%22%3A%5B%222%22%5D%7D

é–‹ç™ºç’°å¢ƒã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«`loadErrorMessages`ã¨`loadDevMessages`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨æ–‡ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript
import { loadErrorMessages, loadDevMessages } from "@apollo/client/dev";

if (process.env.NODE_ENV !== "production") {
  loadErrorMessages();
  loadDevMessages();
}
```

# ã¾ã¨ã‚

Apollo Client å²ä¸Šæœ€å¤§ã®ãƒã‚¤ãƒŠãƒ¼ãƒªãƒªãƒ¼ã‚¹ãªã ã‘ã‚ã‚Šã€ã‹ãªã‚Šå¤§ãã‚ãªæ©Ÿèƒ½ãŒã„ãã¤ã‚‚ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¦ã€ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’èª­ã‚€ã®ãŒã¨ã¦ã‚‚æ¥½ã—ã‹ã£ãŸã§ã™ï¼
ç‰¹ã« Suspense å¯¾å¿œã¯ React18 ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã‹ã‚‰ã€å¾…ã¡ã«å¾…ã£ãŸæ©Ÿèƒ½ãªã®ã§å¬‰ã—ã„ã§ã™ã€‚
`useBackgroundQuery`ã® lazy ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚„ã€`useFragment`ã®`useBackgroundQuery`å¯¾å¿œãªã©ã€ç¾æ™‚ç‚¹ã§å®Ÿè£…ã•ã‚Œã¦ã„ãªã„æ©Ÿèƒ½ã‚‚ä»Šå¾Œè¿½åŠ ã•ã‚Œã‚‹äºˆå®šãªã®ã§ã€å¼•ãç¶šãã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

# å‚è€ƒ

https://www.apollographql.com/blog/announcement/frontend/wait-for-it-announcing-apollo-client-3-8-with-react-suspense-integration/
https://github.com/apollographql/apollo-client/releases/tag/v3.8.0
