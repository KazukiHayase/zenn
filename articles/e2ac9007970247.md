---
title: "Next.js App RouterとApollo Clientの組み合わせ方と仕組みの解説"
emoji: "🐙"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nextjs", "react", "apollo", "graphql", "typescript"]
published: false
publication_name: "drsprime"
---

最近のプロジェクトでNext.jsのApp Routerへの移行を進めていて、その過程でApp RouterとApollo Clientの連携について色々とキャッチアップする機会がありました。
今回は、App RouterとApollo Clientを組み合わせた場合の実装方法と内部の仕組みについて紹介したいと思います！

# App Router + Apollo Clientの実装方法

- apollo-client-integrationsを使う
- registerする
  - https://github.com/KazukiHayase/app-router-apollo-client-catch-up/blob/main/app/ApolloClient.ts
- そのgetClientをサーバーコンポーネントで呼び出して、queryを実行する
  - https://github.com/KazukiHayase/app-router-apollo-client-catch-up/blob/main/app/graphql/page.tsx

# キャッシュについて

- Next.jsのfetchではこうしてる、Apolloではこうしている
- 下記のページのやつを、図を作ってApollo用に紹介する
  - request momeizationがインスタンスになる、data cacheはNext.jsのもの
- https://nextjs.org/docs/app/deep-dive/caching#request-memoization

# 注意点

- SCはサーバーでのみレンダリングされ、CCはサーバーとクライアントの両方でレンダリングされる
- CCはSSRされる可能性がある
- そのため、RSCとSSRを明確に使い分ける、公式でも言及されている
- 完全に使い分ける必要がある
- https://github.com/apollographql/apollo-client-integrations/tree/main/packages/nextjs#usage

# GraphQLとReact Server Componentsの併用について

- GraphQLとRSCは同じ課題を解決する異なるアプローチ
- どちらも、自律的かつ効率的にデータを宣言・取得することを目指している
- 今ゼロからアプリケーションを作るなら、併用する必要はない
- ただ、現行でGraphQLを使っている場合のAppRouterへの移行は必要
- その際のやり方は色々ある

## 設計方針

- どのように併用するか
- このように実装して欲しいという思想はApolloにはなさそう？
- Next.jsに依存しない、将来的に脱することを視野に入れる -> colocationは継続
- Next.jsに依存してRSCの恩恵享受を狙う、REST等への移行を視野に入れる -> SCを積極的に使用していく
- Colocationしてrootでリクエストするのがちょうど良いのでは？
  - そこまで無理してSCを使う必要性はないので、CSに寄せるとかはあり、チームの方針によると思う
  - leafでリクエストしても、memorizeはされない
- Fragment Colocationについて
- やる方が良い
- Next.jsを剥がすかもしれないし、CCで使いたいかもしれない
- leafで取得するか迷うので、rootで取得に統一の方が良い
- CSに寄せるのもアリかも

# まとめ

<!-- 

# 参考 
- https://zenn.dev/cybozu_frontend/articles/next-caching-dedupe#automatic-fetch()-request-deduping-%2F-fetch()-%E3%81%AE%E8%87%AA%E5%8B%95%E9%87%8D%E8%A4%87%E6%8E%92%E9%99%A4
- https://github.com/apollographql/apollo-client-integrations/tree/main/packages/nextjs

-->
