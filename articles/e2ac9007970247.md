---
title: "Next.js App Router Ã— Apollo Clientã«ãŠã‘ã‚‹å®Ÿè£…æ–¹æ³•ã¨å†…éƒ¨ã®ä»•çµ„ã¿"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "react", "apollo", "graphql", "approuter"]
published: true
publication_name: "drsprime"
---

æœ€è¿‘ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§Next.jsã®App Routerã¸ã®ç§»è¡Œã‚’é€²ã‚ã¦ã„ã¦ã€ãã®éç¨‹ã§App Routerã¨Apollo Clientã®é€£æºã«ã¤ã„ã¦è‰²ã€…ã¨ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸã€‚
ãã“ã§ä»Šå›ã¯ã€App Routerã¨Apollo Clientã‚’çµ„ã¿åˆã‚ã›ãŸå ´åˆã®å®Ÿè£…æ–¹æ³•ã¨å†…éƒ¨ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

è¨˜äº‹ã®ä¸­ã§ä½¿ç”¨ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã«ã‚ã‚‹ã®ã§ã€èˆˆå‘³ãŒã‚ã‚Œã°è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚

https://github.com/KazukiHayase/app-router-apollo-client-catch-up

# App Router + Apollo Clientã®å®Ÿè£…æ–¹æ³•

App Routerã¨Apollo Clientã‚’çµ„ã¿åˆã‚ã›ã‚‹å ´åˆã¯ã€[@apollo/client-integration-nextjs](https://github.com/apollographql/apollo-client-integrations)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

https://github.com/apollographql/apollo-client-integrations

## Server Componentsã®å ´åˆ

Server Components(ä»¥ä¸‹SC)ã§Apollo Clientã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€Apollo Clientã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’`registerApolloClient`ã§ç™»éŒ²ã—ã¾ã™ã€‚

```ts
import {ApolloClient, HttpLink, InMemoryCache} from "@apollo/client";
import {registerApolloClient} from "@apollo/client-integration-nextjs";

export const {getClient} = registerApolloClient(() => {
  return new ApolloClient({
    cache: new InMemoryCache(),
    link: new HttpLink({
      uri: "http://localhost:3000/api/graphql",
    }),
  });
});
```

ä¸Šè¨˜ã§ç™»éŒ²ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€SCã§Queryã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx
import gql from "graphql-tag";
import {getClient} from "@/app/ApolloClient";

const userQuery = gql`
  query {
    getUser(id: "1") {
      id
      name
    }
  }
`;

export default async function Page() {
  const {data} = await getClient().query({query: userQuery});

  return <p>data received during Page render: {JSON.stringify(data)}</p>;
}
```

å¾Œã»ã©èª¬æ˜ã—ã¾ã™ãŒã€`getClient`å†…éƒ¨ã§ã¯ã€[React.cache](https://ja.react.dev/reference/react/cache)ãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§ã¯åŒä¸€ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€`getClient`ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Client Componentsã®å ´åˆ

Client Components(ä»¥ä¸‹CC)ã®å ´åˆã¯ã€`@apollo/client-integration-nextjs`ã®Providerã‚’ä½¿ç”¨ã—ã¦ã€Apollo Clientã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
å¾“æ¥ã®`@apollo/client`ã®`ApolloProvider`ã§ã¯ã€ã™ã§ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã•ã‚ŒãŸ`client`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Propsã§å—ã‘å–ã‚Šã¾ã™ãŒã€`ApolloNextAppProvider`ã§ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®`makeClient`ã¨ã„ã†é–¢æ•°ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

```tsx
"use client";

import {HttpLink} from "@apollo/client";
import {
  ApolloNextAppProvider,
  ApolloClient,
  InMemoryCache,
} from "@apollo/client-integration-nextjs";

function makeClient() {
  const httpLink = new HttpLink({
    uri: "http://localhost:3000/api/graphql",
  });

  return new ApolloClient({
    cache: new InMemoryCache(),
    link: httpLink,
  });
}

export function ApolloWrapper({children}: React.PropsWithChildren) {
  return (
    <ApolloNextAppProvider makeClient={makeClient}>
      {children}
    </ApolloNextAppProvider>
  );
}
```

## fetchOptionsã«ã¤ã„ã¦

Next.js App Routerã§ã¯Next.jsç‹¬è‡ªã«æ‹¡å¼µã•ã‚ŒãŸ`fetch`é–¢æ•°ãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€ã“ã®é–¢æ•°ã«ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡ãªã©ã®ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚Apollo Clientã§ã‚‚ã€ã“ã®æ‹¡å¼µã•ã‚ŒãŸfetchã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Apollo Clientã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹éš›ã«ã€`HttpLink`ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦`fetchOptions`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ã™ã¹ã¦ã®GraphQLãƒªã‚¯ã‚¨ã‚¹ãƒˆã«Next.jsã®fetchã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã§ãã¾ã™ã€‚

```ts
export const {getClient} = registerApolloClient(() => {
  return new ApolloClient({
    cache: new InMemoryCache(),
    link: new HttpLink({
      uri: "http://localhost:3000/api/graphql",
      fetchOptions: {
        cache: "no-store",
        next: {revalidate: 0},
      },
    }),
  });
});
```

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆæ™‚ã«æŒ‡å®šã—ãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ãŸã„å ´åˆã¯ã€Queryå®Ÿè¡Œæ™‚ã«`context`ã§`fetchOptions`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx
export default async function Page() {
  const {data} = await getClient().query({
    query: userQuery,
    context: {
      fetchOptions: {
        cache: "force-cache",
        next: {revalidate: 10},
      },
    },
  });

  return <p>data received during Page render: {JSON.stringify(data)}</p>;
}
```

æŒ‡å®šã§ãã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€Next.jsã®`fetch`é–¢æ•°ã§æŒ‡å®šã§ãã‚‹ã‚‚ã®ã¨åŒã˜ã§ã™ã€‚

https://nextjs.org/docs/app/api-reference/functions/fetch#fetchurl-options

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä»•çµ„ã¿

## Request Memoization

Next.jsã§ã¯[Request Memoization](https://nextjs.org/docs/app/deep-dive/caching#request-memoization)ã«ã‚ˆã‚Šã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã®åŒä¸€ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒ¡ãƒ¢åŒ–ã•ã‚Œã¦é‡è¤‡ã—ã¦å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€é‡è¤‡æ’é™¤ã•ã‚Œã‚‹ã®ã¯`fetch`ã«ã‚ˆã‚‹`GET`ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿ã§ã€GraphQLã®ã‚ˆã†ãª`POST`ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯é‡è¤‡æ’é™¤ã•ã‚Œã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€GraphQLã®å ´åˆã¯[React.cache](https://ja.react.dev/reference/react/cache)ã‚’ä½¿ç”¨ã—ã¦ã€ç‹¬è‡ªã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¡ãƒ¢åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«`@apollo/client-integration-nextjs`ã§ã¯ã€`getClient`ã®å†…éƒ¨ã§`React.cache`ã‚’ä½¿ã„ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã‚’ãƒ¡ãƒ¢åŒ–ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€åŒã˜ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã«å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹`getClient`ã¯åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```ts
// èª¬æ˜ã®ãŸã‚ã«ä¸€éƒ¨çœç•¥ã—ãŸã‚³ãƒ¼ãƒ‰
function makeGetClient<
  AC extends Promise<ApolloClient<any>> | ApolloClient<any>,
>(makeClient: () => AC): () => AC {
  function makeWrappedClient() {
    return { client: makeClient() };
  }

  // React.cacheã‚’ä½¿ç”¨ã—ã¦ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆã‚’ãƒ¡ãƒ¢åŒ–
  const cachedMakeWrappedClient = cache(makeWrappedClient);

  function getClient() {
    // ãƒ¡ãƒ¢åŒ–ã•ã‚ŒãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦å–å¾—ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™
    const wrapper = cachedMakeWrappedClient();
    return wrapper.client;
  }
  return getClient;
}
```

https://github.com/apollographql/apollo-client-integrations/blob/main/packages/client-react-streaming/src/registerApolloClient.tsx#L116C1-L164C2

## åŒä¸€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å†…ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡æ’é™¤

å‰è¿°ã®é€šã‚Šã€`getClient`å†…éƒ¨ã§ã¯`React.cache`ã«ã‚ˆã‚‹ãƒ¡ãƒ¢åŒ–ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ãŸã‚ã€åŒã˜ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã«è¤‡æ•°å›`getClient`ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã‚‚ã€åŒä¸€ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€Apollo Clientã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡ã‚’åŠ¹ç‡çš„ã«æ’é™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€ã‚ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§Queryã‚’å®Ÿè¡Œã—ãŸå¾Œã€åŒã˜ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å†…ã®åˆ¥ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§Queryã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã‚’ä¾‹ã«æŒ™ã’ã¾ã™ã€‚
ä¸‹è¨˜ã®ä¾‹ã§ã¯`Child`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å®Ÿè¡Œã™ã‚‹Queryã¯ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ‡ãƒ¼ã‚¿ãŒã™ã§ã«å­˜åœ¨ã™ã‚‹ãŸã‚ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å®Ÿè¡Œã•ã‚Œãšã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã•ã‚Œã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€åŒä¸€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å†…ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡æ’é™¤ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```tsx
const userQuery = gql`
  query {
    getUser(id: "1") {
      id
      name
    }
  }
`;

export default async function Page() {
  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹
  const {data} = await getClient().query({query: userQuery});

  return (
    <>
      <p>data received during Page render: {JSON.stringify(data)}</p>
      <Child />
    </>
  );
}

const userIdQuery = gql`
  query {
    getUser(id: "1") {
      id
    }
  }
`;

const Child = async function () {
  // Pageã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å®Ÿè¡Œã—ãŸQueryã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å®Ÿè¡Œã•ã‚Œãªã„
  const {data} = await getClient().query({query: userIdQuery});

  return <p>data received during Child render: {JSON.stringify(data)}</p>;
};
```

ãŸã ã—æ³¨æ„ç‚¹ã¨ã—ã¦ã€ã“ã®æŒ™å‹•ã¯Apollo Clientã®é€šå¸¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä»•çµ„ã¿ã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿é‡è¤‡æ’é™¤ãŒæ©Ÿèƒ½ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å°‘ã—ã§ã‚‚è¶³ã‚Šãªã„ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
ä¸Šè¨˜ã®ä¾‹ã§ã¯ã€`userQuery`->`userIdQuery`ã®é †ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€`userIdQuery`ã§è¦æ±‚ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å­˜åœ¨ã—ã¾ã™ãŒã€ä¸‹è¨˜ã®ã‚ˆã†ã«`userIdQuery`->`userQuery`ã®é †ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€`userQuery`ã§è¦æ±‚ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆå…·ä½“çš„ã«ã¯`name`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```tsx
const userIdQuery = gql`
  query {
    getUser(id: "1") {
      id
    }
  }
`;

export default async function Page() {
  const {data} = await getClient().query({query: userIdQuery});

  return (
    <>
      <p>data received during Page render: {JSON.stringify(data)}</p>
      <Child />
    </>
  );
}

const userQuery = gql`
  query {
    getUser(id: "1") {
      id
      name
    }
  }
`;

const Child = async function () {
  // Pageã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å®Ÿè¡Œã—ãŸQueryã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ã¯ãƒ‡ãƒ¼ã‚¿ãŒè¶³ã‚Šãªã„ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹
  const {data} = await getClient().query({query: userQuery});

  return <p>data received during Child render: {JSON.stringify(data)}</p>;
};
```

Apolloã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä»•çµ„ã¿è‡ªä½“ã¯å¾“æ¥ã®ã‚‚ã®ã¨å¤‰ã‚ã‚‰ãªã„ã®ã§ã€è©³ç´°ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼

https://zenn.dev/buyselltech/articles/b64935ea7d6fee

## `React.cache`ã®æŒ™å‹•

`React.cache`ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯[RSCã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ç„¡åŠ¹åŒ–](https://ja.react.dev/reference/react/cache#caveats)ã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç ´æ£„ã•ã‚Œã‚‹ãŸã‚ã€ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå…±æœ‰ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã“ã‚Œã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é¢ã§ã‚‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã§ã€ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå…±æœ‰ã•ã‚Œã‚‹ã¨ã€å€‹äººæƒ…å ±ãªã©ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¼æ´©ã™ã‚‹ãƒªã‚¹ã‚¯ãŒå‡ºã¦ãã‚‹ãŸã‚æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

`getClient`ã®å†…éƒ¨å®Ÿè£…ã§ã‚‚ã€ç•°ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå…±æœ‰ã•ã‚Œã¦ã„ãªã„ã‹æ¤œçŸ¥ã—ã¦ã€è­¦å‘Šã‚’å‡ºã™å‡¦ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

```tsx
// èª¬æ˜ã®ãŸã‚ã«ä¸€éƒ¨çœç•¥ã—ãŸã‚³ãƒ¼ãƒ‰
function makeGetClient<
  AC extends Promise<ApolloClient<any>> | ApolloClient<any>,
>(makeClient: () => AC): () => AC {
  // ãƒ©ãƒƒãƒ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç•°ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå…±æœ‰ã•ã‚Œã¦ã„ãªã„ã‹æ¤œçŸ¥ã§ãã‚‹
  // ãƒ©ãƒƒãƒ—ã—ãªã„ã¨åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§ã®å‚ç…§ãªã®ã‹ã€ç•°ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§ã®å‚ç…§ãªã®ã‹ã®åŒºåˆ¥ãŒã¤ã‹ãªã„
  function makeWrappedClient() {
    return { client: makeClient() };
  }

  const cachedMakeWrappedClient = cache(makeWrappedClient);

  function getClient() {
    const wrapper = cachedMakeWrappedClient();
    if (seenWrappers && seenClients) {
      if (!seenWrappers.has(wrapper)) {
        // ç•°ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå…±æœ‰ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã¯è­¦å‘Šã‚’å‡ºã™
        if (seenClients.has(wrapper.client)) {
          console.warn(/* ... */);
        }
        seenWrappers.add(wrapper);
        seenClients.add(wrapper.client);
      }
    }
    return wrapper.client;
  }
  return getClient;
}
```

# Client Componentsã¨SSR

App Routerã«ãŠã‘ã‚‹é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã®1ã¤ã«ã€CCã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®æŒ™å‹•ãŒã‚ã‚Šã¾ã™ã€‚
SCã¯ã‚µãƒ¼ãƒãƒ¼ã§ã®ã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ãŒã€CCã¯**ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä¸¡æ–¹**ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚CCã¯ãƒšãƒ¼ã‚¸ã¸ã®æœ€åˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã‚„ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã¯ã‚µãƒ¼ãƒãƒ¼ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã€ãã®å¾Œã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚

https://nextjs.org/docs/app/building-your-application/rendering/client-components#how-are-client-components-rendered

ãã®ãŸã‚ã€`@apollo/client-integration-nextjs`ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚‚ã€[RSCã¨SSRã‚’æ˜ç¢ºã«ä½¿ã„åˆ†ã‘ã¦ã„ã‚‹](https://github.com/apollographql/apollo-client-integrations/tree/main/packages/nextjs#usage)ã“ã¨ãŒè¨€åŠã•ã‚Œã¦ã„ã¾ã™ã€‚

> â—ï¸ We do handle "RSC" and "SSR" use cases as completely separate.

CCã¯ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä¸¡æ–¹ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãŸã‚ã€SSRæ™‚ã«å®Ÿè¡Œã•ã‚ŒãŸCCã®Queryã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ›´æ–°ã«ã‚ˆã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶å´ã§å‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚
ã—ã‹ã—ã€SCã§å®Ÿè¡Œã•ã‚ŒãŸQueryã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶å´ã§å‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€SCã¨CCã§åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã‚‹å ´åˆã€ãã‚Œãã‚Œã®ãƒ‡ãƒ¼ã‚¿ã«å·®åˆ†ãŒç”Ÿã¾ã‚ŒUIã«ä¸æ•´åˆãŒç”Ÿã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€SCã¨CCã§å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯æ˜ç¢ºã«åˆ†ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# ã¾ã¨ã‚

ä»Šå›ã¯App Routerã¨Apollo Clientã‚’çµ„ã¿åˆã‚ã›ãŸå®Ÿè£…æ–¹æ³•ã¨å†…éƒ¨ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸï¼

RSCã¨GraphQLã¯åŒã˜èª²é¡Œã«å¯¾ã™ã‚‹ç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãªã®ã§ã€æ–°è¦ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã‚¼ãƒ­ã‹ã‚‰é–‹ç™ºã™ã‚‹å ´åˆã¯ã€ä½µç”¨ã™ã‚‹ã“ã¨ã¯ã‚ã¾ã‚Šãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚å€‹äººçš„ã«ã¯ã€ã©ã¡ã‚‰ã‹ä¸€æ–¹ã«å¯„ã›ã‚‹æ–¹ãŒè‰¯ã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ã€ç¾çŠ¶ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã™ã§ã«GraphQLã‚’æ¡ç”¨ã—ã¦ã„ã¦ã€App Routerã¸ã®ç§»è¡Œã‚’æ¤œè¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã—ã°ã‚‰ãã®é–“ã¯ä½µç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ãã†ã„ã£ãŸå ´åˆã«ã€ä»Šå›ç´¹ä»‹ã—ãŸå†…å®¹ãŒå‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ï¼

ã¾ãŸã€RSCã¨GraphQLã‚’ä½µç”¨ã™ã‚‹å ´åˆã®è¨­è¨ˆæ–¹é‡ã¨ã—ã¦ã€å…¨ã¦CCã«å¯„ã›ã‚‹ãªã©ã€ã„ãã¤ã‹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ãã‚Œã‚‰ã«ã¤ã„ã¦ã‚‚æ¤œè¨ã®ä½™åœ°ãŒã‚ã‚‹ã®ã§ã€åˆ¥ã®æ©Ÿä¼šã«ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
