---
title: "Next.js App RouterとApollo Clientの組み合わせ方と仕組みの解説"
emoji: "🐙"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nextjs", "react", "apollo", "graphql", "typescript"]
published: false
publication_name: "drsprime"
---

最近のプロジェクトでNext.jsのApp Routerへの移行を進めていて、その過程でApp RouterとApollo Clientの連携について色々とキャッチアップする機会がありました。
今回は、App RouterとApollo Clientを組み合わせた場合の実装方法と内部の仕組みについて紹介したいと思います！

記事の中で使用するサンプルコードは下記にあるので、興味があれば見てみてください。

https://github.com/KazukiHayase/app-router-apollo-client-catch-up

# App Router + Apollo Clientの実装方法

App RouterとApollo Clientを組み合わせる場合は、[@apollo/client-integration-nextjs](https://github.com/apollographql/apollo-client-integrations)を使用します。

https://github.com/apollographql/apollo-client-integrations

## Server Componentsの場合

Server Components(以下SC)でApollo Clientを使用するために、Apollo Clientのインスタンスを`registerApolloClient`で登録します。

```ts
import {ApolloClient, HttpLink, InMemoryCache} from "@apollo/client";
import {registerApolloClient} from "@apollo/client-integration-nextjs";

export const {getClient} = registerApolloClient(() => {
  return new ApolloClient({
    cache: new InMemoryCache(),
    link: new HttpLink({
      uri: "http://localhost:3000/api/graphql",
    }),
  });
});
```

上記で登録したインスタンスを、各コンポーネントで使用することで、SCでQueryを実行することができます。

```tsx
import gql from "graphql-tag";
import {getClient} from "@/app/ApolloClient";

const userQuery = gql`
  query {
    getUser(id: "1") {
      id
      name
    }
  }
`;

export default async function Page() {
  const {data} = await getClient().query({query: userQuery});

  return <p>data received during Page render: {JSON.stringify(data)}</p>;
}
```

後ほど説明しますが、`getClient`内部では、[React.cache](https://ja.react.dev/reference/react/cache)が使用されており、同一リクエスト内では同一のインスタンスが使用されるようになっています。
そのため、`getClient`はコンポーネント内で呼び出す必要があります。

## Client Componentsの場合

Client Components(以下CC)の場合は、`@apollo/client-integration-nextjs`のProviderを使用して、Apollo Clientのインスタンスを登録します。
従来の`@apollo/client`の`ApolloProvider`では、すでにインスタンス化された`client`オブジェクトをPropsで受け取りますが、`ApolloNextAppProvider`ではインスタンスを生成するための`makeClient`という関数を受け取ります。

```tsx
"use client";

import {HttpLink} from "@apollo/client";
import {
  ApolloNextAppProvider,
  ApolloClient,
  InMemoryCache,
} from "@apollo/client-integration-nextjs";

function makeClient() {
  const httpLink = new HttpLink({
    uri: "http://localhost:3000/api/graphql",
  });

  return new ApolloClient({
    cache: new InMemoryCache(),
    link: httpLink,
  });
}

export function ApolloWrapper({children}: React.PropsWithChildren) {
  return (
    <ApolloNextAppProvider makeClient={makeClient}>
      {children}
    </ApolloNextAppProvider>
  );
}
```

## fetchOptionsについて

Next.js App RouterではNext.js独自に拡張された`fetch`関数が使用されており、この関数にはキャッシュ制御などのためのオプションを渡すことができます。Apollo Clientでも、この拡張されたfetchオプションを活用することができます。

Apollo Clientのインスタンスを生成する際に、`HttpLink`のオプションとして`fetchOptions`を指定することで、すべてのGraphQLリクエストにNext.jsのfetchオプションを適用できます。

```ts
export const {getClient} = registerApolloClient(() => {
  return new ApolloClient({
    cache: new InMemoryCache(),
    link: new HttpLink({
      uri: "http://localhost:3000/api/graphql",
      fetchOptions: {
        cache: "no-store",
        next: {revalidate: 0},
      },
    }),
  });
});
```

インスタンス生成時に指定したオプションをリクエストごとにオーバーライドしたい場合は、Query実行時に`context`で`fetchOptions`を指定することができます。

```tsx
export default async function Page() {
  const {data} = await getClient().query({
    query: userQuery,
    context: {
      fetchOptions: {
        cache: "force-cache",
        next: {revalidate: 10},
      },
    },
  });

  return <p>data received during Page render: {JSON.stringify(data)}</p>;
}
```

指定できるオプションは、Next.jsの`fetch`関数で指定できるものと同じです。

https://nextjs.org/docs/app/api-reference/functions/fetch#fetchurl-options

# キャッシュの仕組み

## Request Memoization

 Next.jsでは[Request Memoization](https://nextjs.org/docs/app/deep-dive/caching#request-memoization)により、レンダリング中の同一のAPIリクエストはメモ化されて重複して実行されないようになっています。
しかし、重複排除されるのは`fetch`による`GET`リクエストのみで、GraphQLのような`POST`リクエストは重複排除されません。
そのため、GraphQLの場合は[React.cache](https://ja.react.dev/reference/react/cache)を使用して、独自でAPIリクエストをメモ化する必要があります

それを実現するために`@apollo/client-integration-nextjs`では、`getClient`の内部で`React.cache`を使い、インスタンスを生成する関数をメモ化しています。
これにより、同じレンダリング中に呼び出されている`getClient`は同じインスタンスを返すようになっています。

```ts
// わかりやすくするために簡略化したコード
function makeGetClient<
  AC extends Promise<ApolloClient<any>> | ApolloClient<any>,
>(makeClient: () => AC): () => AC {
  function makeWrappedClient() {
    return { client: makeClient() };
  }

  // React.cacheを使用して、インスタンスの生成をメモ化
  const cachedMakeWrappedClient = cache(makeWrappedClient);

  function getClient() {
    // メモ化された関数を呼び出して取得したインスタンスを返す
    const wrapper = cachedMakeWrappedClient();
    return wrapper.client;
  }
  return getClient;
}
```

https://github.com/apollographql/apollo-client-integrations/blob/main/packages/client-react-streaming/src/registerApolloClient.tsx#L116C1-L164C2

## 同一リクエスト内でのAPIリクエストの重複排除

- 同じレンダリング内で`getClient`が同一のApolloインスタンスを返すことで、Apolloインスタンスにキャッシュがある場合は、リクエストは実行されず、キャッシュからデータが取得される
- そのため、RSCサーバー->APIサーバーの不要なリクエストを削減できる

- 注意点としては、Apolloのキャッシュにデータがあればそれが使用されるが、そうでなければリクエストは実行されるので、同じレンダリング中のAPIリクエストが全て重複排除されるわけではない
  - キャッシュの仕組みは従来のものと同じなので、下記とかを参考にしてください
  - https://zenn.dev/buyselltech/articles/b64935ea7d6fee

## 補足

- ちなみに、`React.cache`によるキャッシュはRSCサーバーへのリクエストごとに無効化されるので、リクエストを跨いで同じインスタンスが使われることはない
- 実装の不備等で、異なるリクエストで同じインスタンスを参照している場合は、warningが出るようになっている
  - そのためにラップオブジェクトを使用している
  - https://github.com/apollographql/apollo-client-integrations/blob/main/packages/client-react-streaming/src/registerApolloClient.tsx#L142-L160

# 注意点、RSCとCCのSSR

- SCはサーバーでのみレンダリングされ、CCはサーバーとクライアントの両方でレンダリングされる
- CCはSSRされる可能性がある
- そのため、RSCとSSRを明確に使い分ける、公式でも言及されている
- 完全に使い分ける必要がある
- https://github.com/apollographql/apollo-client-integrations/tree/main/packages/nextjs#usage
- CCの場合もリクエストごとにインスタンスを分けるように
  - CCは初回はSSRされることに触れた方が良さそう

# まとめ

- RSCとGraphQLは同じ課題を解決する異なるアプローチなので、併用はしないほうが良いとかは触れておく
- 別の機会に紹介したい

<!-- 

# 参考 
- https://zenn.dev/cybozu_frontend/articles/next-caching-dedupe#automatic-fetch()-request-deduping-%2F-fetch()-%E3%81%AE%E8%87%AA%E5%8B%95%E9%87%8D%E8%A4%87%E6%8E%92%E9%99%A4
- https://github.com/apollographql/apollo-client-integrations/tree/main/packages/nextjs

-->
