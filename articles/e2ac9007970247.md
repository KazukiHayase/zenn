---
title: "Next.js App Routerã¨Apollo Clientã®çµ„ã¿åˆã‚ã›æ–¹ã¨ä»•çµ„ã¿ã®è§£èª¬"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "react", "apollo", "graphql", "typescript"]
published: false
publication_name: "drsprime"
---

æœ€è¿‘ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§Next.jsã®App Routerã¸ã®ç§»è¡Œã‚’é€²ã‚ã¦ã„ã¦ã€ãã®éç¨‹ã§App Routerã¨Apollo Clientã®é€£æºã«ã¤ã„ã¦è‰²ã€…ã¨ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸã€‚
ä»Šå›ã¯ã€App Routerã¨Apollo Clientã‚’çµ„ã¿åˆã‚ã›ãŸå ´åˆã®å®Ÿè£…æ–¹æ³•ã¨å†…éƒ¨ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

è¨˜äº‹ã®ä¸­ã§ä½¿ç”¨ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã«ã‚ã‚‹ã®ã§ã€èˆˆå‘³ãŒã‚ã‚Œã°è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚

https://github.com/KazukiHayase/app-router-apollo-client-catch-up

# App Router + Apollo Clientã®å®Ÿè£…æ–¹æ³•

App Routerã¨Apollo Clientã‚’çµ„ã¿åˆã‚ã›ã‚‹å ´åˆã¯ã€[@apollo/client-integration-nextjs](https://github.com/apollographql/apollo-client-integrations)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

https://github.com/apollographql/apollo-client-integrations

## Server Componentsã®å ´åˆ

Server Components(ä»¥ä¸‹SC)ã§Apollo Clientã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€Apollo Clientã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’`registerApolloClient`ã§ç™»éŒ²ã—ã¾ã™ã€‚

```ts
import {ApolloClient, HttpLink, InMemoryCache} from "@apollo/client";
import {registerApolloClient} from "@apollo/client-integration-nextjs";

export const {getClient} = registerApolloClient(() => {
  return new ApolloClient({
    cache: new InMemoryCache(),
    link: new HttpLink({
      uri: "http://localhost:3000/api/graphql",
    }),
  });
});
```

ä¸Šè¨˜ã§ç™»éŒ²ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€SCã§Queryã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx
import gql from "graphql-tag";
import {getClient} from "@/app/ApolloClient";

const userQuery = gql`
  query {
    getUser(id: "1") {
      id
      name
    }
  }
`;

export default async function Page() {
  const {data} = await getClient().query({query: userQuery});

  return <p>data received during Page render: {JSON.stringify(data)}</p>;
}
```

å¾Œã»ã©èª¬æ˜ã—ã¾ã™ãŒã€`getClient`å†…éƒ¨ã§ã¯ã€[React.cache](https://ja.react.dev/reference/react/cache)ãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§ã¯åŒä¸€ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€`getClient`ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Client Componentsã®å ´åˆ

Client Components(ä»¥ä¸‹CC)ã®å ´åˆã¯ã€`@apollo/client-integration-nextjs`ã®Providerã‚’ä½¿ç”¨ã—ã¦ã€Apollo Clientã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
å¾“æ¥ã®`@apollo/client`ã®`ApolloProvider`ã§ã¯ã€ã™ã§ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã•ã‚ŒãŸ`client`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Propsã§å—ã‘å–ã‚Šã¾ã™ãŒã€`ApolloNextAppProvider`ã§ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®`makeClient`ã¨ã„ã†é–¢æ•°ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

```tsx
"use client";

import {HttpLink} from "@apollo/client";
import {
  ApolloNextAppProvider,
  ApolloClient,
  InMemoryCache,
} from "@apollo/client-integration-nextjs";

function makeClient() {
  const httpLink = new HttpLink({
    uri: "http://localhost:3000/api/graphql",
  });

  return new ApolloClient({
    cache: new InMemoryCache(),
    link: httpLink,
  });
}

export function ApolloWrapper({children}: React.PropsWithChildren) {
  return (
    <ApolloNextAppProvider makeClient={makeClient}>
      {children}
    </ApolloNextAppProvider>
  );
}
```

## fetchOptionsã«ã¤ã„ã¦

Next.js App Routerã§ã¯Next.jsç‹¬è‡ªã«æ‹¡å¼µã•ã‚ŒãŸ`fetch`é–¢æ•°ãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€ã“ã®é–¢æ•°ã«ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡ãªã©ã®ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚Apollo Clientã§ã‚‚ã€ã“ã®æ‹¡å¼µã•ã‚ŒãŸfetchã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Apollo Clientã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹éš›ã«ã€`HttpLink`ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦`fetchOptions`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ã™ã¹ã¦ã®GraphQLãƒªã‚¯ã‚¨ã‚¹ãƒˆã«Next.jsã®fetchã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã§ãã¾ã™ã€‚

```ts
export const {getClient} = registerApolloClient(() => {
  return new ApolloClient({
    cache: new InMemoryCache(),
    link: new HttpLink({
      uri: "http://localhost:3000/api/graphql",
      fetchOptions: {
        cache: "no-store",
        next: {revalidate: 0},
      },
    }),
  });
});
```

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆæ™‚ã«æŒ‡å®šã—ãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ãŸã„å ´åˆã¯ã€Queryå®Ÿè¡Œæ™‚ã«`context`ã§`fetchOptions`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx
export default async function Page() {
  const {data} = await getClient().query({
    query: userQuery,
    context: {
      fetchOptions: {
        cache: "force-cache",
        next: {revalidate: 10},
      },
    },
  });

  return <p>data received during Page render: {JSON.stringify(data)}</p>;
}
```

æŒ‡å®šã§ãã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€Next.jsã®`fetch`é–¢æ•°ã§æŒ‡å®šã§ãã‚‹ã‚‚ã®ã¨åŒã˜ã§ã™ã€‚

https://nextjs.org/docs/app/api-reference/functions/fetch#fetchurl-options

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä»•çµ„ã¿

## Request Memoization

 Next.jsã§ã¯[Request Memoization](https://nextjs.org/docs/app/deep-dive/caching#request-memoization)ã«ã‚ˆã‚Šã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã®åŒä¸€ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒ¡ãƒ¢åŒ–ã•ã‚Œã¦é‡è¤‡ã—ã¦å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ã—ã‹ã—ã€é‡è¤‡æ’é™¤ã•ã‚Œã‚‹ã®ã¯`fetch`ã«ã‚ˆã‚‹`GET`ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿ã§ã€GraphQLã®ã‚ˆã†ãª`POST`ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯é‡è¤‡æ’é™¤ã•ã‚Œã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€GraphQLã®å ´åˆã¯[React.cache](https://ja.react.dev/reference/react/cache)ã‚’ä½¿ç”¨ã—ã¦ã€ç‹¬è‡ªã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¡ãƒ¢åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

ãã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«`@apollo/client-integration-nextjs`ã§ã¯ã€`getClient`ã®å†…éƒ¨ã§`React.cache`ã‚’ä½¿ã„ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã‚’ãƒ¡ãƒ¢åŒ–ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€åŒã˜ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã«å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹`getClient`ã¯åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```ts
// ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«ç°¡ç•¥åŒ–ã—ãŸã‚³ãƒ¼ãƒ‰
function makeGetClient<
  AC extends Promise<ApolloClient<any>> | ApolloClient<any>,
>(makeClient: () => AC): () => AC {
  function makeWrappedClient() {
    return { client: makeClient() };
  }

  // React.cacheã‚’ä½¿ç”¨ã—ã¦ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆã‚’ãƒ¡ãƒ¢åŒ–
  const cachedMakeWrappedClient = cache(makeWrappedClient);

  function getClient() {
    // ãƒ¡ãƒ¢åŒ–ã•ã‚ŒãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦å–å¾—ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™
    const wrapper = cachedMakeWrappedClient();
    return wrapper.client;
  }
  return getClient;
}
```

https://github.com/apollographql/apollo-client-integrations/blob/main/packages/client-react-streaming/src/registerApolloClient.tsx#L116C1-L164C2

## åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡æ’é™¤

- åŒã˜ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å†…ã§`getClient`ãŒåŒä¸€ã®Apolloã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ã§ã€Apolloã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å®Ÿè¡Œã•ã‚Œãšã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã•ã‚Œã‚‹
- ãã®ãŸã‚ã€RSCã‚µãƒ¼ãƒãƒ¼->APIã‚µãƒ¼ãƒãƒ¼ã®ä¸è¦ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šæ¸›ã§ãã‚‹

- æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ã€Apolloã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã‚ŒãŒä½¿ç”¨ã•ã‚Œã‚‹ãŒã€ãã†ã§ãªã‘ã‚Œã°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å®Ÿè¡Œã•ã‚Œã‚‹ã®ã§ã€åŒã˜ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå…¨ã¦é‡è¤‡æ’é™¤ã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„
  - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä»•çµ„ã¿ã¯å¾“æ¥ã®ã‚‚ã®ã¨åŒã˜ãªã®ã§ã€ä¸‹è¨˜ã¨ã‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„
  - https://zenn.dev/buyselltech/articles/b64935ea7d6fee

## è£œè¶³

- ã¡ãªã¿ã«ã€`React.cache`ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯RSCã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è·¨ã„ã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½¿ã‚ã‚Œã‚‹ã“ã¨ã¯ãªã„
- å®Ÿè£…ã®ä¸å‚™ç­‰ã§ã€ç•°ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‚ç…§ã—ã¦ã„ã‚‹å ´åˆã¯ã€warningãŒå‡ºã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹
  - ãã®ãŸã‚ã«ãƒ©ãƒƒãƒ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
  - https://github.com/apollographql/apollo-client-integrations/blob/main/packages/client-react-streaming/src/registerApolloClient.tsx#L142-L160

# æ³¨æ„ç‚¹ã€RSCã¨CCã®SSR

- SCã¯ã‚µãƒ¼ãƒãƒ¼ã§ã®ã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã€CCã¯ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä¸¡æ–¹ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
- CCã¯SSRã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- ãã®ãŸã‚ã€RSCã¨SSRã‚’æ˜ç¢ºã«ä½¿ã„åˆ†ã‘ã‚‹ã€å…¬å¼ã§ã‚‚è¨€åŠã•ã‚Œã¦ã„ã‚‹
- å®Œå…¨ã«ä½¿ã„åˆ†ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹
- https://github.com/apollographql/apollo-client-integrations/tree/main/packages/nextjs#usage
- CCã®å ´åˆã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ†ã‘ã‚‹ã‚ˆã†ã«
  - CCã¯åˆå›ã¯SSRã•ã‚Œã‚‹ã“ã¨ã«è§¦ã‚ŒãŸæ–¹ãŒè‰¯ã•ãã†

# ã¾ã¨ã‚

- RSCã¨GraphQLã¯åŒã˜èª²é¡Œã‚’è§£æ±ºã™ã‚‹ç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãªã®ã§ã€ä½µç”¨ã¯ã—ãªã„ã»ã†ãŒè‰¯ã„ã¨ã‹ã¯è§¦ã‚Œã¦ãŠã
- åˆ¥ã®æ©Ÿä¼šã«ç´¹ä»‹ã—ãŸã„

<!-- 

# å‚è€ƒ 
- https://zenn.dev/cybozu_frontend/articles/next-caching-dedupe#automatic-fetch()-request-deduping-%2F-fetch()-%E3%81%AE%E8%87%AA%E5%8B%95%E9%87%8D%E8%A4%87%E6%8E%92%E9%99%A4
- https://github.com/apollographql/apollo-client-integrations/tree/main/packages/nextjs

-->
