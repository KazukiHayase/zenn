---
title: "AWS SAM + OpenAPI(Swagger) + Golang ã§ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãªAPIã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ™„"
type: "tech"
topics:
  - "aws"
  - "go"
published: true
published_at: "2021-07-13 08:07"
publication_name: "buyselltech"
---

# ã¯ã˜ã‚ã«
AWS SAM + OpenAPI(Swagger) + Golangã‚’ä½¿ã£ã¦ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãªAPIã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

# SAMã¨ã¯ï¼Ÿ
SAM(Serverless Application Model)ã¯ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®AWSå…¬å¼ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚yamlå½¢å¼ã§ç°¡å˜ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã§ãã€SAM CLIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚lambdaã®å®Ÿè¡Œç’°å¢ƒã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»–ã«ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å€™è£œã¨ã—ã¦ServerlessFrameworkãŒã‚ã‚Šã¾ã™ãŒã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®é–‹ç™ºç’°å¢ƒã®æ§‹ç¯‰ã¯SAMã®æ–¹ãŒã—ã‚„ã™ã„ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚

# OpenAPIã¨ã¯ï¼Ÿ
OpenAPIã¯REST APIã®ãŸã‚ã®APIè¨˜è¿°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã€APIã®ä»•æ§˜ã‚’yamlå½¢å¼ã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸopenapi-generatorãªã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§å®šç¾©ã—ãŸOpenAPIã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ¼ãƒ‰ãªã©ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯APIã®å®šç¾©ã¨APIGatewayã®ç”Ÿæˆã«ä½¿ç”¨ã—ã¾ã™ã€‚

# ç’°å¢ƒ
- SAM CLI 1.23.0
- Golang 1.16

# SAMãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™
ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ã‚³ãƒãƒ³ãƒ‰å…¥åŠ›å¾Œã€å¯¾è©±å½¢å¼ã§å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã„ãã¾ã™ã€‚

```sh
$ sam init

-----------------------
Generating application:
-----------------------
Name: sam-app
Runtime: go1.x
Dependency Manager: mod
Application Template: hello-world
Output Directory: .
```

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å…ƒã«å¤§æ ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚ä»Šå›ã¯GETã¨POSTã§å‘¼ã³å‡ºã™ç”¨ã®lambdaã‚’ï¼’ã¤ä½œæˆã—ã¾ã™ã€‚
å¤‰æ›´å¾Œã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```
 â”œâ”€â”€ get
 â”‚   â””â”€â”€ main.go
 â”œâ”€â”€ post
 â”‚   â””â”€â”€ main.go
 â”œâ”€â”€ go.mod
 â”œâ”€â”€ go.sum
 â”œâ”€â”€ openapi.yaml
 â””â”€â”€ template.yaml
```

## å„lambdaå®šç¾©
æ¬¡ã«lambdaã®å®šç¾©ã‚’ã—ã¦ã„ãã¾ã™ã€‚ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«HelloWorldã¨è¿”ã™é–¢æ•°ã¨ã€é€ã‚‰ã‚Œã¦ããŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å°‘ã—åŠ å·¥ã—ã¦è¿”ã™é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚


```go:get/main.go
package main

import (
	"encoding/json"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

type Response struct {
	Message string `json:"message"`
}

func handler() (events.APIGatewayProxyResponse, error) {

	body := Response{Message: "Hello World"}
	jsonBody, err := json.Marshal(body)
	if err != nil {
		panic(err)
	}

	return events.APIGatewayProxyResponse{
		Body:       string(jsonBody),
		StatusCode: 200,
	}, nil
}

func main() {
	lambda.Start(handler)
}


```

```go:post/main.go
package main

import (
	"encoding/json"
	"fmt"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

type Person struct {
	Name string `json:"name"`
	Age  int    `json:"age"`
}

type Response struct {
	Message string `json:"message"`
}

func handler(request events.APIGatewayProxyRequest) (events.APIGatewayProxyResponse, error) {

	var p Person
	b := []byte(request.Body)

	err := json.Unmarshal(b, &p)
	if err != nil {
		panic(err)
	}

	body := Response{Message: fmt.Sprintf("Hello %v : %v", p.Name, p.Age)}
	jsonBody, err := json.Marshal(body)
	if err != nil {
		panic(err)
	}

	return events.APIGatewayProxyResponse{
		Body:       string(jsonBody),
		StatusCode: 200,
	}, nil
}

func main() {
	lambda.Start(handler)
}


```

# APIã®è¨­è¨ˆ
lambdaã®å®šç¾©ãŒçµ‚ã‚ã£ãŸã®ã§æœ¬é¡Œã®APIã®å®šç¾©ã‚’ã—ã¦ã„ãã¾ã™ã€‚

## template.yaml

```yaml:template.yaml
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  sam-app

  Sample SAM Template for sam-app

Globals:
  Function:
    Timeout: 5
    Runtime: go1.x

Resources:
  ApiRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: api-execution-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - apigateway.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: api-execution-role-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - Fn::Sub: ${GetFunction.Arn}
                  - Fn::Sub: ${PostFunction.Arn}
  Api:
    Type: AWS::Serverless::Api
    Properties:
      Name: "rest-api"
      StageName: dev
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: ./openapi.yaml # å‚ç…§ã™ã‚‹yamlãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
  GetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: get/
      Handler: get
  PostFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: post/
      Handler: post

```
APIGatewayã«ä»˜ä¸ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã¨APIGatewayã€å„lambdaã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚DefinitionBodyã§`openapi.yaml`ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§`openapi.yaml`ã®å®šç¾©ã‚’å…ƒã«APIGatewayã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸ[Fn::Transform](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html)ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å‚ç…§ã—ãŸ`openapi.yaml`å†…ã§CloudFormationå›ºæœ‰ã®å¤‰æ•°ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## openapi.yaml

```yaml:openapi.yaml
openapi: 3.0.0
info:
  title: OpenAPI sam-app
  description: sam-appã®API
  version: 1.0.0

paths:
  /hello:
    get:
      summary: GETã‚µãƒ³ãƒ—ãƒ«
      description: GETã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™
      responses:
        '200':
          description: æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'
      x-amazon-apigateway-integration:
        credentials:
          Fn::Sub: ${ApiRole.Arn}
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetFunction.Arn}/invocations
        passthroughBehavior: when_no_templates
        httpMethod: POST
        type: aws_proxy
    post:
      summary: POSTã‚µãƒ³ãƒ—ãƒ«
      description: POSTã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  description: åå‰
                  type: string
                age:
                  description: å¹´é½¢
                  type: integer
                  format: int32
              required:
                - name
                - age
      responses:
        '200':
          description: æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'
      x-amazon-apigateway-integration:
        credentials:
          Fn::Sub: ${ApiRole.Arn}
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${PostFunction.Arn}/invocations
        passthroughBehavior: when_no_templates
        httpMethod: POST
        type: aws_proxy

components:
  schemas:
    Success:
      description: æˆåŠŸã®å ´åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
      type: object
      properties:
        message:
          type: string
      required:
        - message
```
[x-amazon-apigateway-integration](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-swagger-extensions-integration.html)ã¯OpenAPI ã®ä»•æ§˜ã«å¯¾ã™ã‚‹API Gatewayã®æ‹¡å¼µã§ã™ã€‚`credentials`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§`template.yaml`ã§å®šç¾©ã—ãŸãƒ­ãƒ¼ãƒ«ã€`uri`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ãã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾å¿œã™ã‚‹lambdaã‚’æŒ‡å®šã—ã¦ã¾ã™ã€‚

# å‹•ä½œç¢ºèª
ä¸Šè¨˜ã®å®Ÿè£…ãŒå®Œäº†ã—ãŸã‚‰ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```sh
$ sam build
```
ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰APIã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ›ã‚¹ãƒˆã—ã¾ã™ã€‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§`template.yaml`ã¨`openapi.yaml`ã‚’å…ƒã«Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã¦ã€ã™ã¹ã¦ã®é–¢æ•°ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ« HTTP ã‚µãƒ¼ãƒãƒ¼ãŒä½œæˆã•ã‚Œã¾ã™ï¼
```sh
$ sam local start-api

Mounting GetFunction at http://127.0.0.1:3000/hello [GET]
Mounting PostFunction at http://127.0.0.1:3000/hello [POST]
You can now browse to the above endpoints to invoke your functions. You do not need to restart/reload SAM CLI while working on your functions, changes will be reflected instantly/automatically. You only need to restart SAM CLI if you update your AWS SAM template
2021-06-08 02:16:59  * Running on http://127.0.0.1:3000/ (Press CTRL+C to quit)
```
ä¸Šè¨˜ã®ã‚ˆã†ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰curlã‚’å©ã„ã¦ç¹‹ãã“ã¿ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
```sh
$ curl --request GET --url http://127.0.0.1:3000/hello
{"message": "Hello World"}

$ curl --request POST --url http://127.0.0.1:3000/hello --data '{"name": "Taro", "age": 20}'
{"message":"Hello Taro : 20"}
```
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦æ¥ã¦ãŸã‚‰OKã§ã™ï¼

# ãƒ‡ãƒ—ãƒ­ã‚¤
ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å‹•ä½œç¢ºèªãŒã§ããŸã‚‰æœ€å¾Œã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã„ã£ã¦ã‚‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã ã‘ã§å®Œäº†ã—ã¾ã™ã€‚
ã‚³ãƒãƒ³ãƒ‰å…¥åŠ›å¾Œã„ãã¤ã‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®å…¥åŠ›ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™ãŒå…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§OKã§ã™ï¼
```sh
$ sam deploy --capabilities CAPABILITY_NAMED_IAM --guided
```
ä½œæˆã—ãŸAPIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ã„ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ããŸã‚‰å…¨ã¦å®Œäº†ã§ã™ï¼

# ã¾ã¨ã‚
ä»Šå›ã¯SAMã¨OpenAPIã‚’çµ„ã¿åˆã‚ã›ã¦ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãªAPIã‚’ä½œæˆã—ã¾ã—ãŸã€‚
SAMã¨OpenAPIã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ç°¡å˜ã«APIã‚’ä½œæˆã§ãã€ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãªé–‹ç™ºãŒã§ãã‚‹ã¨æ€ã„ã¾ã™ï¼


